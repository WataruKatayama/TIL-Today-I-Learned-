# 最初の環境構築  
### WebサーバとAPIサーバの二つの部分に分け、サーバはそれぞれ、Amazon VPC内に構築したPublic Subnetの中に、Amazon EC2を用いて構築する  
  
※Webサーバ：ブラウザ上で実行されるWebアプリケーションで、必要な情報をAPIサーバから取得し、ユーザーに表示させる  
　APIサーバ：Webサーバからのリクエストに基づき適切な処理を行い、レスポンスを返す  

  
## VPCの作成  
● 新規VPCとして、reservation-vpcを作成する  
● CIDRの指定は10.0.0.0/21とする  
  
 <手順>  
 1.ダッシュボードから「お使いのVPC」を選択し、右上「VPCを作成」を選択  
 2.作成するリソース「VPCのみ」、名前タグ、オプション「reservation-vpc」、IPv4CIDRブロック「IPv4CIDRの手動入力」、IPv4CIDR「10.0.0.0/21」、テナンシー「デフォルト」、タグ「Name」「reservation-vpc」に設定し「VPCを作成」をクリック  
 3.正常にVPCが作成されれば完了  

 ## web-subnet-01を作成  
● Webサーバを配置するためのサブネットとして、web-subnet-01を作成する  
● CIDRの指定は10.0.0.0/24とする  
● ルートテーブルとしてweb-routetableを作成し、web-subnet-01に関連付けする  
  
<手順 サブネットの作成>  
1.ダッシュボードから「サブネット」を選択し、右上「サブネットを作成」を選択  
2.VPCID「reservation-vpc（作成したVPC名）」、サブネット名「web-subnet-01」、アベイラビリティゾーン「ap-nothest-1a」、IPv4 VPC CIDRブロック「そのまま」、IPv4サブネットCIDRブロック「10.0.0.0/24」、タグ「Name」「web-subnet-01」に設定し「サブネットを作成」をクリック  
3.正常にweb-subnet-01が作成されれば完了  
  
<手順　ルートテーブルの作成 + 関連付け>  
1.ダッシュボードから「ルートテーブル」を選択し、右上「ルートテーブルを作成」を選択  
2.名前オプション「web-routetable」、VPC「reservation-vpc（作成したVPC名）」、タグ「Name」「web-routetable」に設定し「ルートテーブルを作成」をクリック  
3.正常にweb-routetableが作成されれば作成完了  
4.作成されたルートテーブル「web-routetable」にチェックを入れ、下にある「サブネットの関連付け」をクリック  
5.右側の「サブネットの関連付けを編集」をクリックし、「web-routetable」にチェックを入れ、「関連付けを保存」をクリック  
6.ルートテーブルの詳細画面に移動するので、「サブネットの関連付け」をクリックし、サブネットIDが表示されていれば関連付け完了  
  
 ## api-subnet-01を作成  
● APIサーバを配置するためのサブネットとして、api-subnet-01を作成する  
● CIDRの指定は10.0.1.0/24とする  
● ルートテーブルとしてapi-routetableを作成し、api-subnet-01に関連付けする  
  
<手順 サブネットの作成>  
1.ダッシュボードから「サブネット」を選択し、右上「サブネットを作成」を選択  
2.VPCID「reservation-vpc（作成したVPC名）」、サブネット名「api-subnet-01」、アベイラビリティゾーン「ap-nothest-1a」、IPv4 VPC CIDRブロック「そのまま」、IPv4サブネットCIDRブロック「10.0.1.0/24」、タグ「Name」「api-subnet-01」に設定し「サブネットを作成」をクリック  
3.正常にweb-subnet-01が作成されれば完了  
  
<手順　ルートテーブルの作成 + 関連付け>  
1.ダッシュボードから「ルートテーブル」を選択し、右上「ルートテーブルを作成」を選択  
2.名前オプション「api-routetable」、VPC「reservation-vpc（作成したVPC名）」、タグ「Name」「api-routetable」に設定し「ルートテーブルを作成」をクリック  
3.正常にapi-routetableが作成されれば作成完了  
4.作成されたルートテーブル「api-routetable」にチェックを入れ、下にある「サブネットの関連付け」をクリック  
5.右側の「サブネットの関連付けを編集」をクリックし、「api-routetable」にチェックを入れ、「関連付けを保存」をクリック  
6.ルートテーブルの詳細画面に移動するので、「サブネットの関連付け」をクリックし、サブネットIDが表示されていれば関連付け完了  
  
## インターネットゲートウェイの作成  
● reservation-igという名前のインターネットゲートウェイを作成し web-routetableおよびapi-routetableに設定する  
  
<手順　インターネットゲートウェイ>  
1.ダッシュボードから「インターネットゲートウェイ」を選択し、右上「インターネットゲートウェイの作成」を選択  
2.名前タグ「 reservation-ig」、タグオプション「Name」「reservation-ig」に設定し「インターネットゲートウェイの作成」クリック  
3.詳細画面に移動するので画面右の「アクション」から「VPCにアタッチ」を選択する  
　→状態が「Detached(どこのVPCにも設定されていないという意味)」なのでアタッチの設定もセットで必要  
4.使用可能なVPCに「reservation-vpc（作成したVPC名）」を選択し「インターネットゲートウェイのアタッチ」をクリック  
5.詳細画面に移り、VPCのIDが表示され、状態が「Atached」になっていれば設定完了  
  
<手順　インターネットゲートウェイとルートテーブルのルーティング>  
1.ダッシュボードから「ルートテーブル」を選択し、Webルートテーブルにチェックを入れる  
2.下にある「ルート」をクリックし、右にある「ルートを編集」をクリック  
3.「ルートを追加」をクリックし「0.0.0.0/0(すべての通信)」、「インターネットゲートウェイ」、igw-「reservation-ig(インターネットゲートウェイの名前)」に設定し、「変更を保存」をクリック  
4.詳細画面に移り、0.0.0.0/0のルートテーブルが追加されていれば設定完了  
　→これでルートテーブルとインターネットゲートウェイとでデータが行き来できるようになる  
5.APIルートテーブルも同じ手順でルートテーブル0.0.0.0/0を追加する  
  
## APIサーバの構築  
● api-subnet-01の中にEC2インスタンスを一つ作成し、api-server-01とする  
● EC2インスタンス作成時のAMIは、Amazon Linux 2023を選択する  
● APIサーバおよびWebサーバに対するインバウンド通信は、「すべての HTTP通信」のみとする  
● ただし、メンテナンスのためのssh接続が必要な場合は、許可しても構わない  
  
<手順　EC2インスタンスの準備（SSH接続ができる状態まで）>  
1.EC2インスタンスの画面まで移り、ダッシュボードから「インスタンス」を選択し、画面右の「インスタンスの起動」をクリックする  
2.名前とタグ「api-server-01」、クイックスタートAMI「Amazon Linux 2023」、アーキテクチャ「64ビット（x86）」、インスタンスタイプ「t2.maicro」、キーペアは新規作成でキーペア名「api-ec2-key」キーペアのタイプ「RSA」キー形式「.pem」でキーペアを作成する  
→キーペアと同じ名前のキーファイルがダウンロードされるのでとりあえずデスクトップにファイルを保存しておく  
3.ネットワーク設定の「編集」をクリックし、VPC-必須「reservation-vpc」、サブネット「api-subnet-01」、パブリックIPの自動割り当て「無効化（有効化にすると自動でIPアドレスを割り振ってくれる）」、ファイアウォール「セキュリティグループを作成」、セキュリティグループ名「api-sg-1」、説明にも同じく「api-sg-1」に設定する  
4.インバウンドのセキュリティグループのルールは下記の通りとなる  
　「APIサーバおよびWebサーバに対するインバウンド通信は、「すべての HTTP通信」のみとする」  
 　→タイプ「HTTP」、プロトコル「TCP」、ポート80、ソースタイプ「カスタム」「0.0.0.0/0」  
  
　「ただし、メンテナンスのためのssh接続が必要な場合は、許可しても構わない」  
 　→セキュリティの観点から、SSH（ポート22）は常に開けっ放しにせず、自分のIPアドレスのみ許可  
  　タイプ「ssh」、プロトコル「TCP」、ポート22、ソースタイプ「自分のIP」  
 5.ストレージはそのままで「インスタンスを起動」をクリック  
 6.「すべてのインスタンスを表示」をクリックしEC2のインスタンス画面へ移る  
 7.ステータスチェック画面が「2/2のチェックに合格しました」と表示されれば起動完了  
